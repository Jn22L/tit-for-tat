<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="/socket.io/tit-for-tat/socket.io.js"></script>
    <style>
      #div-your-wrapper {
        display: flex;
      }
      #div-my-wrapper {
        display: flex;
      }
      #div-etc-wrapper {
        display: flex;
      }
    </style>
    <title>tftv3</title>
  </head>
  <body>
    <div id="div-join-wrapper"><input id="input-join" maxlength="8" autocomplete="off" /><button id="btn-join">J</button></div>
    <div id="div-your-wrapper">
      <label>temp(YOU):</label>
      <div id="div-your-id"></div>
    </div>
    <div id="div-playground-wrapper"><button id="btn-enter-game">TEST</button></div>
    <div id="div-my-wrapper">
      <label>temp(MY):</label>
      <div id="div-my-id"></div>
    </div>
    <div id="div-etc-wrapper">
      <label>temp(ETC):</label>
      <div id="div-etc-ids"></div>
      <div id="div-etc-user-count"></div>
    </div>
    <script>
      //const socket = io();
      const socket = io.connect({ path: "/socket.io/tit-for-tat/", transports: ["websocket"] });

      let tempLoginId; // 로그인 시도 ID

      let allLoginPlayerArr = []; // 모든 로그인 유저목록(비로그인 제외) [{playerNo:1 , nickName:""}]
      let myInfo = { isLoginOk: false, isPlayer: false, nickName: "", playerNo: 0 };
      let player1Info = { nickName: "" };
      let player2Info = { nickName: "" };

      const divJoinWrapper = document.querySelector("#div-join-wrapper");
      const inputJoin = document.querySelector("#input-join");
      const btnJoin = document.querySelector("#btn-join");
      const divYourWrapper = document.querySelector("#div-your-wrapper");
      const divYourId = document.querySelector("#div-your-id");
      const divPlaygroundWrapper = document.querySelector("#div-playground-wrapper");
      const btnEnterGame = document.querySelector("#btn-enter-game");
      const divMyWrapper = document.querySelector("#div-my-wrapper");
      const divMyId = document.querySelector("#div-my-id");
      const divEtcWrapper = document.querySelector("#div-etc-wrapper");
      const divEtcIds = document.querySelector("#div-etc-ids");
      const divEtcUserCount = document.querySelector("#div-etc-user-count");

      /************************************************************************
       * Local Event List
       ***********************************************************************/
      // 로그인 클릭
      btnJoin.addEventListener("click", function (e) {
        if (inputJoin.value.trim() === "" || inputJoin.value == null) {
          alert("please enter name");
          inputJoin.focus();
          return;
        }
        tempLoginId = inputJoin.value;
        socket.emit("join user", tempLoginId);
      });

      // 게임참여 클릭
      btnEnterGame.addEventListener("click", function (e) {
        if (!myInfo.isLoginOk) {
          alert("not login user");
          return;
        }
        if (myInfo.isPlayer) {
          alert("already in the game");
          return;
        }
        socket.emit("enter game", myInfo.nickName);
      });

      /************************************************************************
       * Server Event List
       ***********************************************************************/
      // 로그인
      socket.on("join user", function (serverMsg) {
        console.log("join user", serverMsg);

        /*----- 닉네임 중복체크 -----*/
        if (tempLoginId === serverMsg.nickName) {
          if (serverMsg.isLoginOk) {
            // 정상
            divJoinWrapper.setAttribute("style", "visibility:hidden;");
            divYourWrapper.setAttribute("style", "visibility:visible;");
            divMyWrapper.setAttribute("style", "visibility:visible;");
            console.log("myInfo:", myInfo);
            myInfo.isLoginOk = serverMsg.isLoginOk;
            myInfo.isPlayer = false;
            myInfo.nickName = serverMsg.nickName;
            myInfo.playerNo = serverMsg.playerNo;
            tempLoginId = null;
          } else {
            // 중복
            divJoinWrapper.setAttribute("style", "visibility:visible;");
            divYourWrapper.setAttribute("style", "visibility:hidden;");
            divMyWrapper.setAttribute("style", "visibility:hidden;");
            alert(tempLoginId + "(은/는) 이미 사용중인 이름 입니다. 다른 이름으로 로그인해 주세요.");
            return;
          }
        }

        if (!serverMsg.isLoginOk) return; // 비정상 로그인건은 무조건 리턴

        /*----- 중복없을때 정상진행 -----*/
        setPlayersLayout(serverMsg.loginUserList); // 화면변경:선수배치
      });

      // 게임 참여
      socket.on("enter game", function (serverMsg) {
        console.log("enter game:", serverMsg);
        if (myInfo.nickName === serverMsg.nickName) {
          if (serverMsg.isPlayer) {
            myInfo.isPlayer = true;
            myInfo.playerNo = serverMsg.playerNo;
            alert("Success to join the game.");
          } else {
            myInfo.isPlayer = false;
            myInfo.playerNo = serverMsg.playerNo;
            alert("Fail to join the game.");
          }
        }
        setPlayersLayout(serverMsg.loginUserList); // 화면변경:선수배치
      });

      // 로그 아웃
      socket.on("user logout", function (serverMsg) {
        console.log("user logout:", serverMsg);
        // if (myInfo.nickName === serverMsg.nickName) {
        //   if (serverMsg.isPlayer) {
        //     myInfo.isPlayer = true;
        //     myInfo.playerNo = serverMsg.playerNo;
        //     alert("Success to join the game.");
        //   } else {
        //     myInfo.isPlayer = false;
        //     myInfo.playerNo = serverMsg.playerNo;
        //     alert("Fail to join the game.");
        //   }
        // }
        setPlayersLayout(serverMsg.loginUserList); // 화면변경:선수배치
      });
      /************************************************************************
       * function list
       ***********************************************************************/
      /**
       * 선수자리배치(화면변경)
       * @param loginUserList: 로그인 유저목록
       * @return
       */
      function setPlayersLayout(loginUserList) {
        /* glable setting list
           - data
           allLoginPlayerArr
           player1Info
           player2Info

           - screen
           divYourId : 상대id
           divMyId : 내id
           divEtcIds : 관전id 목록
        */
        player1Info = {};
        player2Info = {};
        allLoginPlayerArr = loginUserList;
        allLoginPlayerArr.forEach(function (elm) {
          if (elm.playerNo === 1) {
            player1Info = elm;
          } else if (elm.playerNo === 2) {
            player2Info = elm;
          }
        });
        //tempP1 = allLoginPlayerArr.filter((v) => v.playerNo === 1);
        //tempP2 = allLoginPlayerArr.filter((v) => v.playerNo === 2);
        //if (tempP1.length > 0) player1Info = tempP1[0];
        //if (tempP2.length > 0) player2Info = tempP2[0];

        console.log("선수배치:allLoginPlayerArr", allLoginPlayerArr);
        console.log("선수배치:player1", player1Info);
        console.log("선수배치:player2", player2Info);

        // 선수배치
        if (myInfo.playerNo === 1) {
          // 내가 1번 선수일때
          divYourId.innerHTML = player2Info.nickName || "게임 대기중";
          divMyId.innerHTML = myInfo.nickName;
        } else if (myInfo.playerNo === 2) {
          // 내가 2번 선수일때
          divYourId.innerHTML = player1Info.nickName || "게임 대기중";
          divMyId.innerHTML = myInfo.nickName;
        } else if (myInfo.playerNo > 2) {
          // 내가 관전일때
          divYourId.innerHTML = player1Info.nickName || "게임 대기중";
          divMyId.innerHTML = player2Info.nickName || "게임 대기중";
        }

        // 관전목록(항상갱신)
        divEtcIds.innerHTML = "";
        allLoginPlayerArr.forEach((elm) => {
          if (elm.playerNo > 2) {
            divEtcIds.insertAdjacentHTML("afterbegin", elm.nickName + " ");
          }
        });
        //divEtcUserCount.innerHTML = `전체:${serverMsg.allUserCount} 로그인:${serverMsg.loginUserList.length} 비로그인:${serverMsg.allUserCount - serverMsg.loginUserList.length}`;
      }
    </script>
  </body>
</html>
