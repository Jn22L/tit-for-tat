<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="/socket.io/tit-for-tat/socket.io.js"></script>
    <style>
      #div-your-wrapper {
        display: flex;
      }
      #div-my-wrapper {
        display: flex;
      }
      #div-etc-wrapper {
        display: flex;
      }
    </style>
    <title>tftv3</title>
  </head>
  <body>
    <div id="div-join-wrapper"><input id="input-join" maxlength="8" autocomplete="off" /><button id="btn-join">J</button></div>
    <div id="div-your-wrapper">
      <label>temp(YOU):</label>
      <div id="div-your-id"></div>
      <div id="div-your-status"></div>
    </div>
    <div id="div-playground-wrapper">
      <button id="btn-playground-enter-game">TEST</button>
      <div id="div-playground-your"></div>
      <div id="div-playground-center"></div>
      <div id="div-playground-my"></div>
    </div>
    <div id="div-my-wrapper">
      <label>temp(MY):</label>
      <div id="div-my-id"></div>
      <button id="btn-my-o">O</button>
      <button id="btn-my-x">X</button>
    </div>
    <div id="div-etc-wrapper">
      <label>temp(ETC):</label>
      <div id="div-etc-ids"></div>
      <div id="div-etc-user-count"></div>
      <ul id="ul-score-list"></ul>
    </div>
    <script>
      //const socket = io();
      const socket = io.connect({ path: "/socket.io/tit-for-tat/", transports: ["websocket"] });

      let tempLoginId; // 로그인 시도 ID

      let loginUserList = []; // 로그인 유저목록(비로그인 제외) [{playerNo:1 , nickName:""}]
      let myInfo = { isLoginOk: false, isPlayer: false, nickName: "", playerNo: 0 };
      let player1Info = { nickName: "", playerNo: 1 };
      let player2Info = { nickName: "", playerNo: 2 };
      let playResultInfo = { round: 1, nextRound: 1, isP1End: false, p1Choice: "", p1Score: 0, isP2End: false, p2Choice: "", p2Score: 0 }; // 개별선택취합결과

      const divJoinWrapper = document.querySelector("#div-join-wrapper");
      const inputJoin = document.querySelector("#input-join");
      const btnJoin = document.querySelector("#btn-join");

      const divYourWrapper = document.querySelector("#div-your-wrapper");
      const divYourId = document.querySelector("#div-your-id");

      const divPlaygroundWrapper = document.querySelector("#div-playground-wrapper");
      const btnPlaygroundEnterGame = document.querySelector("#btn-playground-enter-game");
      const divPlaygroundYour = document.querySelector("#div-playground-your");
      const divPlaygroundCenter = document.querySelector("#div-playground-center");
      const divPlaygroundMy = document.querySelector("#div-playground-my");

      const divMyWrapper = document.querySelector("#div-my-wrapper");
      const divMyId = document.querySelector("#div-my-id");
      const btnMyO = document.querySelector("#btn-my-o");
      const btnMyX = document.querySelector("#btn-my-x");

      const divEtcWrapper = document.querySelector("#div-etc-wrapper");
      const divEtcIds = document.querySelector("#div-etc-ids");
      const divEtcUserCount = document.querySelector("#div-etc-user-count");
      const ulScoreList = document.querySelector("#ul-score-list");

      /************************************************************************
       * Local Event List
       ***********************************************************************/
      // 닉네임 엔터
      inputJoin.addEventListener("keyup", function (e) {
        if (e.key === "Enter") {
          e.preventDefault();
          btnJoin.click();
        }
      });

      // 로그인 클릭
      btnJoin.addEventListener("click", function (e) {
        if (inputJoin.value.trim() === "" || inputJoin.value == null) {
          alert("please enter name");
          inputJoin.focus();
          return;
        }
        tempLoginId = inputJoin.value;
        socket.emit("join user", tempLoginId);
      });

      // 게임참여 클릭
      btnPlaygroundEnterGame.addEventListener("click", function (e) {
        if (!myInfo.isLoginOk) {
          alert("not login user");
          return;
        }
        if (myInfo.isPlayer) {
          alert("already in the game");
          return;
        }
        socket.emit("enter game", myInfo.nickName);
      });

      // 게임진행:O 클릭
      btnMyO.addEventListener("click", function (e) {
        if (!myInfo.isLoginOk) {
          alert("not login user");
          return;
        }
        if (!myInfo.isPlayer) {
          alert("you are not a player");
          return;
        }

        let nextRound = playResultInfo.nextRound; // 둘다선택시 서버에서 라운드 + 1
        socket.emit("play game", { round: nextRound, nickName: myInfo.nickName, playerNo: myInfo.playerNo, choice: "O" });
        btnMyO.disabled = true;
        btnMyX.disabled = true;
      });

      // 게임진행:X 클릭
      btnMyX.addEventListener("click", function (e) {
        if (!myInfo.isLoginOk) {
          alert("not login user");
          return;
        }
        if (!myInfo.isPlayer) {
          alert("you are not a player");
          return;
        }
        let nextRound = playResultInfo.nextRound; // 둘다선택시 서버에서 라운드 + 1
        socket.emit("play game", { round: nextRound, nickName: myInfo.nickName, playerNo: myInfo.playerNo, choice: "X" });
        btnMyO.disabled = true;
        btnMyX.disabled = true;
      });

      /************************************************************************
       * Server Event List
       ***********************************************************************/
      // 비로그인 접속
      socket.on("connect user", function (serverMsg) {
        inputJoin.focus();
        renderPlayerLayout(serverMsg.loginUserList);
        renderUserCount(serverMsg); // 접속유저수
      });

      // 로그 아웃
      socket.on("user logout", function (serverMsg) {
        console.log("user logout");
        renderPlayerLayout(serverMsg.loginUserList);
        renderUserCount(serverMsg); // 접속유저수
      });

      // 로그인
      socket.on("join user", function (serverMsg) {
        console.log("join user", serverMsg);

        /*----- 닉네임 중복체크 -----*/
        if (tempLoginId === serverMsg.nickName) {
          if (serverMsg.isLoginOk) {
            // 정상
            divJoinWrapper.setAttribute("style", "display:none;");
            myInfo.isLoginOk = serverMsg.isLoginOk;
            myInfo.isPlayer = false;
            myInfo.nickName = serverMsg.nickName;
            myInfo.playerNo = serverMsg.playerNo;
            tempLoginId = null;
          } else {
            // 중복
            divJoinWrapper.setAttribute("style", "display:block;");
            alert(tempLoginId + "(은/는) 이미 사용중인 이름 입니다. 다른 이름으로 로그인해 주세요.");
            inputJoin.value = "";
            return;
          }
        }

        if (!serverMsg.isLoginOk) return; // 로그인 실패건 return : 화면변경없음

        /*----- 로그인 성공시 정상진행 -----*/
        renderPlayerLayout(serverMsg.loginUserList); // 화면변경:선수배치
        renderUserCount(serverMsg); // 접속유저수 표시
      });

      // 게임 참여
      socket.on("enter game", function (serverMsg) {
        console.log("enter game");
        if (myInfo.nickName === serverMsg.nickName) {
          if (serverMsg.isPlayer) {
            myInfo.isPlayer = true;
            myInfo.playerNo = serverMsg.playerNo;
            alert("Success to join the game.");
          } else {
            myInfo.isPlayer = false;
            myInfo.playerNo = serverMsg.playerNo;
            alert("Fail to join the game.");
          }
        }
        renderPlayerLayout(serverMsg.loginUserList); // 선수배치(선수1,선수2,관전목록) rendering
      });

      // 게임진행
      socket.on("play game", function (serverMsg) {
        console.log("play game");
        playResultInfo = serverMsg; // 게임결과수신

        // 다음라운드 시작시 버튼 활성화
        if (playResultInfo.round < playResultInfo.nextRound) {
          // 라운드 점수표시 - temp
          var liTemp = document.createElement("li");
          liTemp.innerHTML = `Round ${playResultInfo.round} : ${playResultInfo.p1NickName} ${playResultInfo.p1Choice} ${playResultInfo.p1Score} - ${playResultInfo.p2NickName} ${playResultInfo.p2Choice} ${playResultInfo.p2Score}`;
          ulScoreList.appendChild(liTemp);

          // 선수만 버튼 활성
          if (myInfo.isPlayer) {
            btnMyO.disabled = false;
            btnMyX.disabled = false;
          }
        }
      });

      /************************************************************************
       * function list
       ***********************************************************************/
      /**
       * 선수배치(선수1,선수2,관전목록) rendering
       * @param pLoginUserList: 로그인 유저목록
       * @return
       */
      function renderPlayerLayout(pLoginUserList) {
        console.log("자리배치:화면그리기 myInfo", myInfo);

        /* glable setting list
           - data
           loginUserList // 로그인한 전체유저 목록
           player1Info       // player1 정보
           player2Info       // player2 정보

           - screen
           divYourWrapper       // 상대정보 표시
           divPlaygroundWrapper // 경기장
           divMyWrapper         // 내정보 표시
           divEtcWrapper        // 관전 및 기타정보 표시
        */
        player1Info = {};
        player2Info = {};
        loginUserList = pLoginUserList;
        loginUserList.forEach(function (elm) {
          if (elm.playerNo === 1) {
            player1Info = elm;
          } else if (elm.playerNo === 2) {
            player2Info = elm;
          }
        });

        // 선수배치
        if (myInfo.playerNo === 1) {
          // 내가 1번 선수일때
          divYourId.innerHTML = player2Info.nickName || "게임 대기중";
          divMyId.innerHTML = myInfo.nickName;
        } else if (myInfo.playerNo === 2) {
          // 내가 2번 선수일때
          divYourId.innerHTML = player1Info.nickName || "게임 대기중";
          divMyId.innerHTML = myInfo.nickName;
        } else {
          // 내가 관전일때
          divYourId.innerHTML = player1Info.nickName || "게임 대기중";
          divMyId.innerHTML = player2Info.nickName || "게임 대기중";
        }

        // 선수배치 완료시
        if (player1Info.nickName !== undefined && player2Info.nickName !== undefined) {
          // 게임참여 버튼 감추고
          btnPlaygroundEnterGame.setAttribute("style", "display:none;");
          if (myInfo.isPlayer) {
            // 내가 선수이면, O/X 버튼 enable
            btnMyO.disabled = false;
            btnMyX.disabled = false;
          }
        } else {
          // 선수배치 미완료시 - 게임참여 버튼 보이고, O/X 버튼 disable
          btnPlaygroundEnterGame.setAttribute("style", "display:inline-block;");
          btnMyO.disabled = true;
          btnMyX.disabled = true;
        }

        // 관전목록(항상갱신)
        divEtcIds.innerHTML = "";
        loginUserList.forEach((elm) => {
          if (elm.playerNo > 2) {
            divEtcIds.insertAdjacentHTML("afterbegin", elm.nickName + " ");
          }
        });

        // 비로그인 버튼 비활성
        if (!myInfo.isLoginOk) {
          btnMyO.disabled = true;
          btnMyX.disabled = true;
        }
      }

      /**
       * 접속유저수 표시
       * @param object: { allUserCount: 비로그인포함 전체유저수, loginUserList: 로그인 유저목록 []  }
       * @return
       */
      function renderUserCount(serverMsg) {
        divEtcUserCount.innerHTML = `전체:${serverMsg.allUserCount} 로그인:${serverMsg.loginUserList.length} 비로그인:${serverMsg.allUserCount - serverMsg.loginUserList.length}`;
      }
    </script>
  </body>
</html>
